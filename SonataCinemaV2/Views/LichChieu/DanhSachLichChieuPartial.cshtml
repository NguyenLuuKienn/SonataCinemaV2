@model List<SonataCinemaV2.Models.LichChieu>

<div class="content-wrapper">
    <div class="container-fluid px-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Quản Lý Lịch Chiếu</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#themLichChieuModal">
                <i class="bi bi-plus-circle"></i> Thêm Lịch Chiếu
            </button>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Phim</th>
                                <th>Phòng</th>
                                <th>Ngày Chiếu</th>
                                <th>Giờ Chiếu</th>
                                <th>Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.ID_LichChieu</td>
                                    <td>@item.Phim.TenPhim</td>
                                    <td>@item.PhongChieu.TenPhong</td>
                                    <td>@item.NgayChieu.ToString("dd/MM/yyyy")</td>
                                    <td>@($"{item.GioChieu.Hours:00}:{item.GioChieu.Minutes:00}")</td>
                                    <td style="display:flex">
                                        <button class="btn btn-warning btn-sm" onclick="loadLichChieuEdit(@item.ID_LichChieu)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        @using (Html.BeginForm("XoaLichChieu", "LichChieu", FormMethod.Post, new { id = "deleteForm_" + item.ID_LichChieu }))
                                        {
                                            @Html.AntiForgeryToken()
                                            @Html.Hidden("ID_LichChieu", item.ID_LichChieu)

                                        <button type="button" class="btn btn-danger btn-sm" onclick="if(confirm('Bạn có chắc muốn xóa lịch chiếu này?')) $('#deleteForm_@item.ID_LichChieu').submit();">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        }
                                    </td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Lịch Chiếu -->
<div class="modal fade" id="themLichChieuModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm Lịch Chiếu Mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("ThemLichChieu", "LichChieu", FormMethod.Post, new { @class = "them-form" }))
                {
                    <div class="form-group mb-3">
                        <label>Phim</label>
                        <select class="form-select" name="IDPhim" required>
                            @foreach (var phim in ViewBag.DanhSachPhim)
                            {
                                <option value="@phim.ID_Phim">@phim.TenPhim</option>
                            }
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label>Phòng</label>
                        <select class="form-select" name="IDPhong" required>
                            @foreach (var phong in ViewBag.DanhSachPhong)
                            {
                                <option value="@phong.ID_Phong">@phong.TenPhong</option>
                            }
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label>Từ Ngày</label>
                                <input type="date" class="form-control" name="TuNgay" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label>Đến Ngày</label>
                                <input type="date" class="form-control" name="DenNgay" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label>Giờ Chiếu</label>
                        <input type="time" class="form-control" name="GioChieu" required>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Thêm mới</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Sửa Lịch Chiếu -->
<div class="modal fade" id="suaLichChieuModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sửa Thông Tin Lịch Chiếu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("SuaLichChieu", "LichChieu", FormMethod.Post, new { @class = "edit-form" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" class="edit-ma-lich-chieu" name="ID_LichChieu" />

                    <div class="form-group mb-3">
                        <label>Phim</label>
                        <select class="form-select edit-ma-phim" name="ID_Phim" required>
                            @foreach (var phim in ViewBag.DanhSachPhim)
                            {
                                <option value="@phim.ID_Phim">@phim.TenPhim</option>
                            }
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label>Phòng</label>
                        <select class="form-select edit-ma-phong" name="ID_Phong" required>
                            @foreach (var phong in ViewBag.DanhSachPhong)
                            {
                                <option value="@phong.ID_Phong">@phong.TenPhong</option>
                            }
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label>Ngày Chiếu</label>
                        <input type="date" class="form-control edit-ngay" name="NgayChieu" required>
                    </div>

                    <div class="form-group mb-3">
                        <label>Giờ Chiếu</label>
                        <input type="time" class="form-control edit-gio-chieu" name="GioChieu" required>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Cập nhật</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<script>
    document.addEventListener('DOMContentLoaded', function() {
    function loadLichChieuEdit(maLichChieu) {
    fetch(`@Url.Action("GetLichChieuById", "LichChieu")?id=${maLichChieu}`)
        .then(response => response.json())
        .then(data => {
            console.log("Received data:", data);

            if (data) {
                try {
                    // Set giá trị cho các trường
                    document.querySelector('.edit-ma-lich-chieu').value = data.MaLichChieu;
                    document.querySelector('select[name="ID_Phim"]').value = data.MaPhim;
                    document.querySelector('select[name="ID_Phong"]').value = data.MaPhong;
                    document.querySelector('input[name="NgayChieu"]').value = data.Ngay;
                    document.querySelector('input[name="GioChieu"]').value = data.ThoiGianChieu;

                    const modal = new bootstrap.Modal(document.getElementById('suaLichChieuModal'));
                    modal.show();
                } catch (err) {
                    console.error("Error setting values:", err);
                    console.error("Data received:", data);
                    alert('Có lỗi khi thiết lập dữ liệu: ' + err.message);
                }
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert('Có lỗi xảy ra: ' + error.message);
        });
}

    window.loadLichChieuEdit = loadLichChieuEdit;
});
</script>